'use strict';Object.defineProperty(exports,'__esModule',{value:true});const path=require('path');const chokidar=require('chokidar');const fs=require('fs');const util=require('util');const builder_bot_1=require('./builder-bot');const cli_logger_1=require('../lib/cli-commander/cli.logger');const app_const_1=require('../app.const');const app_const_2=require('../app.const');const misc_utils_1=require('../utils/misc-utils');const exec=util.promisify(require('child_process').exec);class WatcherBot{constructor(){this.name='Watcher Bot 61315';this.debugMode=false;this.watchDir='/mnt/c/Freedom/cm-igniter-build/test-project';this.isProgress=false;this.configureBot();this.initWatchDir();this.startWatchBot();}initWatchDir(){if(false===fs.existsSync(this.watchDir)){cli_logger_1.Logger.logFatalError(`Watch Directory "${this.watchDir}" does not exist, bailing out!`);process.exit(266);}this.changeDir(this.watchDir);}startWatchBot(){let scope=this;let result=false;const watcher=chokidar.watch(this.watchDir,{ignored:/(^|[\/\\])\../,persistent:true});const log=console.log.bind(console);watcher.on('add',function(path){scope.onChange(path,app_const_2.ChangeType.Added);}).on('change',function(path){scope.onChange(path,app_const_2.ChangeType.Changed);}).on('unlink',function(path){scope.onChange(path,app_const_2.ChangeType.Unlink);});}changeDir(targetDir){let currDir=process.cwd();cli_logger_1.Logger.logGreen(`Changing working directory from "${currDir}" to "${targetDir}"`);return new Promise((resolve,reject)=>{try{process.chdir(targetDir);resolve(true);}catch(err){cli_logger_1.Logger.logError('changeDir Error ::',err);reject(err);}});}onChange(filename,cType){if(false===this.isReady){cli_logger_1.Logger.logDebug('onChange, returning since status isReady == false');return;}let changeTypeStr=misc_utils_1.MiscUtils.ChangeTypeToStr(cType);let fileExt=path.extname(filename);switch(cType){case app_const_2.ChangeType.Added:cli_logger_1.Logger.logGreen('ADDED ::',filename+' :: '+fileExt);break;case app_const_2.ChangeType.Changed:cli_logger_1.Logger.logYellow('CHANGED ::',filename+' :: '+fileExt);break;case app_const_2.ChangeType.Unlink:cli_logger_1.Logger.logRed('UNLINKED ::',filename+' :: '+fileExt);break;}if(this.debugMode){this.builderBot.showFileActions();}this.builderBot.commitChange(this.watchDir,filename,cType);}configureBot(){this.builderBot=new builder_bot_1.BuilderBot();this.builderBot.addFileAction('.ts',app_const_1.ActionType.Recompile);}}exports.WatcherBot=WatcherBot;let app=new WatcherBot();